---
title: "VAN_SPF_analysis"
author: "Hephaes"
date: "2022-12-15"
output: html_document
---

# Data import and preliminary analysis 

```{r}
library(devtools)
load_all()
dataVAN <- read.csv("VAN.csv")
dataSPF <- read.csv("SPF.csv")
# on inspection, subject 16 has no NAs; chosen for downstream analysis 
```

## velocity-time plot, for subject 16
```{r}
# extracting velocity vector 
VAN_16u <- dataVAN$VAN.16 # velocity of the 16th subject in van group 
SPF_16u <- dataSPF$SPF.16 # velocity of the 16the subject in spf group

# combining the two velocity vectors for easier plotting 
velocity_data <- cbind(VAN_16u, SPF_16u) %>% as.data.frame() # combind vectors, transform into dataframe
velocity_data$time <- c(1:150) # create time column
velocity_plotdata <- gather(velocity_data, key = "subject", value = "velocity", 1:2) # gather dataset into plottable format
plot <- ggplot(velocity_plotdata, aes(x = time, y = velocity, color = subject)) + geom_line() + theme_classic() # plot 
plot 
```

## velocity-time plot, for all subjects
```{r}
# a function for returning the velocity profile across SPF and VAN conditons for the i-th subject
stimuli_times <- c()
for (i in 0:14){
  leftend <- 1
  rightend <- 5
  stimuli_times <- c(stimuli_times, seq(leftend+i*10, rightend+i*10, by = 0.01))
}
RESULT <- list()
for (i in 1:20) {
  VAN_iu <- dataVAN[i+1] # take the i-th subject velocity vector
  SPF_iu <- dataSPF[i+1]
  velocity_data <- cbind(VAN_iu, SPF_iu) %>% as.data.frame() # combind vectors, transform into dataframe
  velocity_data$time <- c(1:150) # create time column
  velocity_data$SUBJECT <- paste("subject", i) %>% rep(150) # create subject label
  colnames(velocity_data)[1:2] <- c("VAN", "SPF")
  RESULT[[i]] <- velocity_data
}
total_velocitydata <- do.call(rbind, RESULT)
ptotal_velocitydata <- gather(total_velocitydata, "conditions", "velocity", 1:2)
plot <- ggplot(ptotal_velocitydata, aes(x = time, y = velocity, color = conditions)) + geom_line() + geom_vline(xintercept = stimuli_times, color="blue", linewidth = 0.2, alpha = 0.002) + theme_classic() + facet_wrap(vars(SUBJECT), ncol = 3) # plot 
```

## Conclusion from preliminary exploration 
- No clear patterns can be observed when the raw velocities are plotted 
From now on define: 
0. $t_{i}$ represents time $i$
1. $v_{j, t_i}^{(2)}$ velocity of subject $j$ in VAN at time $i$
2. $v_{j, t_i}^{(1)}$ velocity of subject $j$ in SPF at time $i$
3. $v_{j,B}^{(1)}$ represents the baseline velocity of subject $j$ in VAN condition 
4. $v_{j,B}^{(2)}$ represents the baseline velocity of subject $j$ in SPF condition 

We are interested to compute 
1. $$\log{\frac{v_{j, t_i}^{(2)}}{v_{j,B}^{(2)}}}$$
2. $$\log{\frac{v_{j, t_i}^{(1)}}{v_{j,B}^{(1)}}}$$
to represent the normalised velocity for VAN (2) and SPF (1) group 

- $\log{\frac{v_{j, t_i}^{(2)}}{v_{j,B}^{(2)}}}>0$ implies that $\frac{v_{j, t_i}^{(2)}}{v_{j,B}^{(2)}}>1$ (and vice versa); the subject-$j$-specific velocity at time $i$ is larger than the subject-$j$-specific baseline velocity 
- We hope that $\log{\frac{v_{j, t_i}^{(2)}}{v_{j,B}^{(2)}}}$ and $\log{\frac{v_{j, t_i}^{(1)}}{v_{j,B}^{(1)}}}$ exhibit some patterns 

# Analysis on log-transformed data 

```{r}
dataVAN <- read.csv("VAN.csv")
dataSPF <- read.csv("SPF.csv")
```

```{r}
df <- as.data.frame(cbind(c(1,2), c(3,4)))
# df/c(2,3) # rowwise division 

normVAN <- log(dataVAN[2:21])
normSPF <- log(dataSPF[2:21])

RESULT <- list()
for (i in 1:20) {
  VAN_iu <- normVAN[i] # take the i-th subject logvelocity vector
  SPF_iu <- normSPF[i]
  logvelocity_data <- cbind(VAN_iu, SPF_iu) %>% as.data.frame() # combind vectors, transform into dataframe
  logvelocity_data$time <- c(1:150) # create time column
  logvelocity_data$SUBJECT <- paste("subject", i) %>% rep(150) # create subject label
  colnames(logvelocity_data)[1:2] <- c("VAN", "SPF")
  RESULT[[i]] <- logvelocity_data
}
total_velocitydata <- do.call(rbind, RESULT)
ptotal_velocitydata <- gather(total_velocitydata, "conditions", "logvelocity", 1:2)
plot <- ggplot(ptotal_velocitydata, aes(x = time, y = logvelocity, color = conditions)) + geom_line() + geom_vline(xintercept = stimuli_times, color="blue", linewidth = 0.2, alpha = 0.002) + theme_classic() + facet_wrap(vars(SUBJECT), ncol = 3) # plot 
```

## Conclusion
- Some subjects have exhibited many NAs in some conditions; planned to disregard these subjects in subsequent analyses 
- We select subject 18, 20, 16, 13, 14, 17 for subsequent analyses
```{r}
normVAN <- log(dataVAN[2:21])
normSPF <- log(dataSPF[2:21])
RESULT <- list()
for (i in c(13,14,16,17,18,20)) {
  VAN_iu <- normVAN[i] # take the i-th subject logvelocity vector
  SPF_iu <- normSPF[i]
  logvelocity_data <- cbind(VAN_iu, SPF_iu) %>% as.data.frame() # combind vectors, transform into dataframe
  logvelocity_data$time <- c(1:150) # create time column
  logvelocity_data$SUBJECT <- paste("subject", i) %>% rep(150) # create subject label
  colnames(logvelocity_data)[1:2] <- c("VAN", "SPF")
  RESULT[[i]] <- logvelocity_data
}
total_velocitydata <- do.call(rbind, RESULT)
ptotal_velocitydata <- gather(total_velocitydata, "conditions", "logvelocity", 1:2)
plot <- ggplot(ptotal_velocitydata, aes(x = time, y = logvelocity, color = conditions)) + geom_line() + geom_vline(xintercept = stimuli_times, color="blue", linewidth = 0.2, alpha = 0.002) + theme_classic() + facet_wrap(vars(SUBJECT), ncol = 3) # plot 
```

- apply convolution, using stats::convolve; [reference](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/convolve)
```{r}
# try to convolve, for each subject, the SPF and the VAN velocity vector 
start_data <- total_velocitydata
subject17_data <- filter(start_data, SUBJECT == "subject 17")
subt17VAN <- subject17_data$VAN
# subt15VAN[-(subt15VAN == -Inf)]
subt17SPF <- subject17_data$SPF
subtconvt <- stats::convolve(data$VAN.18,dataVAN$VAN.17, conj = TRUE, type = "open")

plot1 <- acf(dataSPF$SPF.18)
plot2 <- acf(dataVAN$VAN.18)
```

## Using the ts class object
```{r}
VAN17 <- ts(data = dataVAN$VAN.17)
SPF17 <- ts(data = dataSPF$SPF.17)
ts.plot(cbind(VAN17, SPF17), ylab = "velocity", lty = c("solid", "dashed"))

VAN18 <- ts(data = dataVAN$VAN.18)
SPF18 <- ts(data = dataSPF$SPF.18)
ts.plot(cbind(VAN18, SPF18), ylab = "velocity", lty = c("solid", "dashed"))

```

# Reanalysis 17 Dec 2022

## data normalisation and preprocessing
```{r}
dataVAN <- read.csv("VAN.csv")
colnames(dataVAN)[2:21] <- paste("subject",c(1:20)) # rename subject
dataSPF <- read.csv("SPF.csv")
colnames(dataSPF)[2:21] <- paste("subject",c(1:20)) # rename subject
dataVAN$time <- c(1:150)
dataSPF$time <- c(1:150)

status <- c() # generate status labels to time
for (i in c(0:14)) {
  stimulus_round <- rep(paste("S", i+1), 5)
  non_stimulus_round <- rep(paste("NS", i+1), 5)
  status <- c(status, stimulus_round, non_stimulus_round)
}
dataSPF$status <- status
dataSPF$condition <- rep("SPF", 150) # append condition labels 
dataVAN$status <- status
dataVAN$condition <- rep("VAN", 150)

dataVAN <- dataVAN[-1]
dataSPF <- dataSPF[-1]
normalVAN <- as.tibble(gather(dataVAN, key = "subject", value = "velocity", 1:20))
normalSPF <- as.tibble(gather(dataSPF, key = "subject", value = "velocity", 1:20))
normalVAN <- mutate(normalVAN, normVelocity = log(velocity + 0.01)) # normalisation occurs here 
normalSPF <- mutate(normalSPF, normVelocity = log(velocity + 0.01))
# normalVAN now contains the normalised velocities of all VAN subjects
total_data <- rbind(normalVAN, normalSPF)
write.csv(total_data, "processed_VAN_SPF.csv")
```

```{r}
total_data <- rbind(normalVAN, normalSPF)
boxplot_comparing_stim_non_stim <- ggplot(total_data, aes(x = condition, y = normVelocity)) + geom_boxplot() + facet_wrap(vars(status)) + theme_classic()
boxplot <- ggplot(total_data, aes(x = time, y = velocity, color = subject)) + geom_line() + theme_classic()

# subject level analysis 

plot <- ggplot(subjectdata, aes(x = time, y = normVelocity, color = status)) + geom_line() + facet_wrap(vars(subject), ncol = 10) + theme_classic()

subject_data <- filter(total_data, subject == "subject 18")
plot <- ggplot(subject_data, aes(x = velocity)) + geom_density() + theme_classic()

```

## linear mixed effects model 
```{r}
total_data$status <- factor(total_data$status)
total_data$condition <- factor(total_data$condition)
total_data$subject <- factor(total_data$subject)

install.packages("lme4")
library(lme4)
install.packages("jtools")
library(jtools)
install.packages("lmerTest")
library(lmerTest)
LME <- lmerTest::lmer(normVelocity ~ time + condition +  (1 + condition | subject), data = total_data)
```

```{r}
# include stimulus condition 
dataVAN <- read.csv("VAN.csv")
colnames(dataVAN)[2:21] <- paste("subject",c(1:20)) # rename subject
dataSPF <- read.csv("SPF.csv")
colnames(dataSPF)[2:21] <- paste("subject",c(1:20)) # rename subject
dataVAN$time <- c(1:150)
dataSPF$time <- c(1:150)

status <- c() # generate status labels to time
for (i in c(0:14)) {
  stimulus_round <- rep(paste("S"), 5) 
  non_stimulus_round <- rep(paste("NS"), 5)
  status <- c(status, stimulus_round, non_stimulus_round)
}
dataSPF$status <- status
dataSPF$condition <- rep("SPF", 150) # append condition labels 
dataVAN$status <- status
dataVAN$condition <- rep("VAN", 150)

dataVAN <- dataVAN[-1]
dataSPF <- dataSPF[-1]
normalVAN <- as.tibble(gather(dataVAN, key = "subject", value = "velocity", 1:20))
normalSPF <- as.tibble(gather(dataSPF, key = "subject", value = "velocity", 1:20))
normalVAN <- mutate(normalVAN, normVelocity = log(velocity + 0.01)) # normalisation occurs here 
normalSPF <- mutate(normalSPF, normVelocity = log(velocity + 0.01))
# normalVAN now contains the normalised velocities of all VAN subjects
total_data2 <- rbind(normalVAN, normalSPF)

#LME <- lmerTest::lmer(normVelocity ~ time + condition + status + (1| subject), data = total_data)
#st <- lmerTest::step(LME)
```


```{r}
# function for getting accelerations 
getchangevelocity <- function(vvector){
  avector <- c()
  for (i in 2:150){
    avector[i-1] <- vvector[i] - vvector[i-1]
  }
  return(avector)
}
AdataVAN <- as.data.frame(apply(dataVAN[1:20], 2, getchangevelocity))
AdataSPF <- as.data.frame(apply(dataSPF[1:20], 2, getchangevelocity))
AdataVAN$time <- c(1:149)
AdataSPF$time <- c(1:149)

status <- c() # generate status labels to time
for (i in c(0:14)) {
  stimulus_round <- rep(paste("S"),i+1, 5) 
  non_stimulus_round <- rep(paste("NS"),i+1, 5)
  status <- c(status, stimulus_round, non_stimulus_round)
}
status <- status[-150]
AdataSPF$status <- status
AdataSPF$condition <- rep("SPF", 149) # append condition labels 
AdataVAN$status <- status
AdataVAN$condition <- rep("VAN", 149)
A_VAN <- as.tibble(gather(AdataVAN, key = "subject", value = "acceleration", 1:20))
A_SPF <- as.tibble(gather(AdataSPF, key = "subject", value = "acceleration", 1:20))
acceleration_data <- rbind(A_VAN, A_SPF)
write.csv(acceleration_data, "acceletation_VAN_SPF.csv")

acceleration_data
```

```{r}
p <- ggplot(acceleration_data, aes(x = time, y = acceleration, color = condition)) + geom_line() + facet_wrap(vars(subject)) + theme_classic()
p <- ggplot(acceleration_data %>% filter(subject == "subject 20"), aes(x = time, y = acceleration, color = condition)) + geom_line() + theme_classic()

LME <- lmerTest::lmer(acceleration ~ time + condition + status + (1| subject), data = acceleration_data)
st <- lmerTest::step(LME)
```

# Wavelet analysis using WaveletComp
```{r}
install.packages("WaveletComp")
library(WaveletComp)
my.w <- analyze.wavelet(total_data %>% filter(subject == "subject 17") %>% filter(condition == "VAN"), "velocity",
loess.span = 0)

my.w2 <- analyze.wavelet(total_data %>% filter(subject == "subject 17") %>% filter(condition == "SPF"), "velocity",
loess.span = 0)

wt.image(my.w, color.key = "quantile", n.levels = 250,
legend.params = list(lab = "wavelet power levels", mar = 4.7))

wt.image(my.w2, color.key = "quantile", n.levels = 250,
legend.params = list(lab = "wavelet power levels", mar = 4.7))

reconstruct(my.w, plot.waves = FALSE, lwd = c(1,2),
legend.coords = "bottomleft")

reconstruct(my.w2, plot.waves = FALSE, lwd = c(1,2),
legend.coords = "bottomleft")

```
# Trying state space modelling using stan


```{r}
library(rstan)
stimulus = c()
for (i in 1:15) {
  stimulus = c(stimulus, rep(1,5), rep(0,5))
}


t_max = 150 
y = filter(total_data, subject == "subject 17") %>% filter(condition == "VAN")
y = y$normVelocity
I = stimulus
theta1_m = 0
theta2_m = 0
theta1_initial_noise = as.matrix(1)
theta2_initial_noise = as.matrix(1)

dlmdata = list(t_max = t_max, y = y, I = I, theta1_m = theta1_m, theta2_m = theta2_m, theta1_initial_noise = theta1_initial_noise, theta2_initial_noise = theta2_initial_noise)

model1 <- stan_model(file = "model1_VAN_SPF.stan")
fit_stan <- sampling(object = model1, data = dlmdata)

params <- summary(fit_stan)
params <- params$summary %>% as.data.frame()
```

```{r}
yrep <- extract(fit_stan, pars = "y_rep")[[1]]
first_instance <- yrep[2,]
y = filter(total_data, subject == "subject 17") %>% filter(condition == "VAN")
y = y$normVelocity
pltdata <- cbind(y, first_instance) %>% as.data.frame()
pltdata$time <- c(1:150)
pltdata <- gather(pltdata, key = "kind", value = "normvelocity", 1:2)
plot <- ggplot(pltdata, aes(x = time, y = normvelocity, color = kind)) + geom_line() + theme_classic() 
```

```{r}
y = filter(total_data, subject == "subject 17") %>% filter(condition == "VAN")
y = y$normVelocity

y1 = filter(total_data, subject == "subject 18") %>% filter(condition == "VAN")
y1 = y1$normVelocity

da <- array(list(y, y1))
```

# Further processing with erf function 

```{r}
scale_logistic <- function(x, k){
  denominator <- 1 + exp(-1*k*x)
  return((1/denominator)-1/2)
}

subject17data <- filter(total_data, subject == "subject 17")
plot <- ggplot(subject17data, aes(x = time, y = velocity)) + geom_line() + geom_area(aes(fill = condition)) + theme_classic() + facet_wrap(vars(condition), ncol=1) + geom_vline(xintercept = stimuli_times, color="blue", linewidth = 0.2, alpha = 0.002)

```



